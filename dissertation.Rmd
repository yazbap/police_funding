---
title: "Dissertation Analysis"
output: html_document
date: "2024-04-11"
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

## Research Question

How do Black Lives Matter protests affect police funding?


```{r set_up, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# read in the libraries
library(tidyverse) 
library(scales)
library(haven)
library(readxl)
library(gridExtra)
library(MatchIt)
library(missForest)
library(knitr)
library(ggplot2)
library(moments)
library(patchwork)

#library(tmap)
#library(sf)
#library(tigris)

```

```{r functions}
# Function to standardize data types based on the first data frame
standardize_data_types <- function(df, first_df) {
  for (col_name in names(first_df)) {
    col_type <- typeof(first_df[[col_name]])
    if (col_type == "integer" || col_type == "numeric") {
      df[[col_name]] <- as.numeric(df[[col_name]])
    } else if (col_type == "character") {
      df[[col_name]] <- as.character(df[[col_name]])
    } else if (col_type == "logical") {
      df[[col_name]] <- as.logical(df[[col_name]])
    }
    # Add conditions for other data types if necessary
  }
  return(df)
}
```

## Data Sources

- **2020 BLM protest Data**
  - Accessed from The Armed Conflict Location & Event Data Project (ACLED)
- **Demographic County Data**
  - Characteristics
    - Percent Female
    - Age 0-18, 19-35, 36-50, 50-65, 65+
    - Percent Black, Asian, White, Hispanic or Latino
    - Person's 25 and older educational attainment
    - Median HH income
  - Accessed from IPUMS National Historical Geographic Information System (NHGIS) from the 2022 American Community Survey (ACS) Summary Files which estimates average characteristics from 2018 to 2022. 
- **Ideology Data**
  - Values are between 0 and 1, lower values are associated with politically left preferences and higher values with politically right preferences
  - Ideology is based on surveys taken between 2017-2021
  - Accessed from the Harvard Dataverse, dataset: Subnational ideology and presidential vote estimates (v2022)
- **Police Killings Data**
  - Average Police Killings Per Capita from 2016 - 2020
  - Accessed from mapping Police Violence


```{r get_protest_data, eval = FALSE}
# Get protest data
raw <- read.csv("data/2020-01-01-2024-04-19-United_States.csv")

blm_df <- raw %>%
  mutate(admin2 = ifelse(event_id_cnty %in% c( "USA4796", "USA17359", 
                                               "USA12192", "USA9274", "USA9021", 
                                               "USA8471", "USA18357"), "new york", admin2)) %>%
  filter(year == 2020) %>%
  filter(str_detect(tolower(assoc_actor_1), "blm")) %>%
  filter(sub_event_type %in% c("Violent demonstration", "Mob violence", 
                               "Peaceful protest", "Protest with intervention",
                               "Excessive force against protesters")) %>%
  mutate(violent_protest = ifelse(sub_event_type %in% 
                                    c("Violent demonstration", "Mob violence"), 
                                  1,0))

cities_blm <- blm_df %>%
  mutate(location = ifelse(location == "", NA, location),  # Replace empty strings with NA
         location = tolower(location),                  # Convert admin2 to lowercase
         admin1 = tolower(admin1),                  # Convert admin1 to lowercase
         state_abbr = state.abb[match(admin1, tolower(state.name))],  # Map state names to abbreviation
         city_state = paste(location, state_abbr, sep = "_")) %>%   # Create county_state column
  group_by(city_state) %>%
  summarize(violent_protest = sum(violent_protest),
            peaceful_protest = n() - violent_protest) %>%
  mutate(violent_protest = ifelse(violent_protest > 0 , 1, 0),
         peaceful_protest = ifelse(peaceful_protest > 0 , 1, 0),
         year = 2020) %>%
  select(year, city_state, violent_protest, peaceful_protest)

counties_blm <- blm_df %>%
  mutate(admin2 = ifelse(admin2 == "", NA, admin2),  # Replace empty strings with NA
         admin2 = tolower(admin2),                  # Convert admin2 to lowercase
         admin1 = tolower(admin1),                  # Convert admin1 to lowercase
         state_abbr = state.abb[match(admin1, tolower(state.name))],  # Map state names to abbreviations
         county_state = paste(admin2, state_abbr, sep = "_")) %>%
  group_by(county_state) %>%
  summarize(violent_protest = sum(violent_protest),
            peaceful_protest = n() - violent_protest) %>%
  mutate(violent_protest = ifelse(violent_protest > 0 , 1, 0),
         peaceful_protest = ifelse(peaceful_protest > 0 , 1, 0),
         year = 2020) %>%
  select(year, county_state, violent_protest, peaceful_protest)
```

```{r get_political_data, eval = FALSE}
cities_pol_ideo <- read_dta("data/aip_cities_ideology_v2022a.dta")
counties_pol_ideo <- read_dta("data/aip_counties_ideology_v2022a.dta")

cities_pol_ideo <- cities_pol_ideo %>%
  filter(survey_period == "2017-2021") %>% #Only use data from most recent surveys
  mutate(state_abbr = state.abb[match(state, state.name)], #get abbreviated states
         city_name = tolower(gsub(" County| Borough| Census Area| Municipality| Parish| city", "", city_name)), #remove suffixes
         city_state = paste(city_name, state_abbr, sep = "_")) %>% #combine county/states
  select(city_state, mrp_ideology)

counties_pol_ideo <- counties_pol_ideo %>%
  filter(survey_period == "2017-2021") %>% #Only use data from most recent surveys
  mutate(state_abbr = state.abb[match(state, state.name)], #get abbreviated states
         county_name = tolower(gsub(" County| Borough| Census Area| Municipality| Parish| city", "", county_name)), #remove suffixes
         county_state = paste(county_name, state_abbr, sep = "_")) %>% #combine county/states
  select(county_state, mrp_ideology)


```

```{r get_demographic_data, eval = FALSE}
cities_demo <- read.csv("data/nhgis0006_ts_nominal_place.csv")
counties_demo <- read.csv("data/nhgis0004_ts_nominal_county.csv")

cities_demo <- cities_demo %>%
  rename(total_pop = AV0AA225,
         num_female = AV1AB225,
         age_under_5 = B57AA225,
         age_5_9 = B57AB225,
         age_10_14 = B57AC225,
         age_15_17 = B57AD225,
         age_18_19 = B57AE225,
         age_20 = B57AF225,
         age_21 = B57AG225,
         age_22_24 = B57AH225,
         age_25_29 = B57AI225,
         age_30_34 = B57AJ225,
         age_35_44 = B57AK225,
         age_45_54 = B57AL225,
         age_55_59 = B57AM225,
         age_60_61 = B57AN225,
         age_62_64 = B57AO225,
         age_65_74 = B57AP225,
         age_75_84 = B57AQ225,
         age_85_up = B57AR225,
         num_black = B07AB225,
         num_white = B07AA225,
         num_asian = B07AD225,
         num_hispanic = A35AA225, 
         num_less_hs = B85AA225,
         num_hs_graduate_GED = B85AC225,
         num_associates = B85AE225,
         num_bachelors = B85AF225,
         num_graduate_professional = B85AG225,
         num_not_in_labor_force = B84AF225,
         median_hh_income = B79AA225
         )%>%
  mutate(percent_female = num_female / total_pop,
         perc_age_0_17 = (age_under_5 + 
                            age_5_9 + 
                            age_10_14 + 
                            age_15_17) / total_pop,
         perc_age_18_34 = (age_18_19 + 
                             age_20 + 
                             age_21 + 
                             age_22_24 + 
                             age_25_29 + 
                             age_30_34) / total_pop,
         perc_age_35_59 = (age_35_44 +
                             age_45_54 +
                             age_55_59) / total_pop,
         perc_age_60_74 = (age_60_61 +
                             age_62_64 +
                             age_65_74) / total_pop,
         perc_75_up = (age_75_84 +
                         age_85_up) / total_pop,
         perc_black = num_black / total_pop,
         perc_asian = num_asian / total_pop,
         perc_white = num_white / total_pop,
         perc_hispanic = num_hispanic / total_pop,
         perc_less_hs = num_less_hs / total_pop,
         perc_associates = num_associates / total_pop,
         perc_bachelors = num_bachelors / total_pop,
         perc_graduate_professional = num_graduate_professional / total_pop,
         perc_not_in_labor_force = num_not_in_labor_force / total_pop,
         state_abbr = state.abb[match(STATE, state.name)],
         PLACE = tolower(gsub(" County| Borough| Census Area| Municipality| Parish| city| town| CDP| village| City", "", PLACE)), #remove suffixes
         city_state = paste(PLACE, state_abbr, sep = "_") #combine county/states
         ) %>%
  select(city_state, percent_female, perc_age_0_17, perc_age_18_34, 
         perc_age_35_59, perc_age_60_74, perc_75_up, perc_black,
         perc_asian, perc_white, perc_hispanic, perc_less_hs, perc_associates,
         perc_bachelors, perc_graduate_professional, perc_not_in_labor_force,
         median_hh_income)

counties_demo <- counties_demo %>%
  rename(total_pop = AV0AA225,
         num_female = AV1AB225,
         age_under_5 = B57AA225,
         age_5_9 = B57AB225,
         age_10_14 = B57AC225,
         age_15_17 = B57AD225,
         age_18_19 = B57AE225,
         age_20 = B57AF225,
         age_21 = B57AG225,
         age_22_24 = B57AH225,
         age_25_29 = B57AI225,
         age_30_34 = B57AJ225,
         age_35_44 = B57AK225,
         age_45_54 = B57AL225,
         age_55_59 = B57AM225,
         age_60_61 = B57AN225,
         age_62_64 = B57AO225,
         age_65_74 = B57AP225,
         age_75_84 = B57AQ225,
         age_85_up = B57AR225,
         num_black = B07AB225,
         num_white = B07AA225,
         num_asian = B07AD225,
         num_hispanic = A35AA225, 
         num_less_hs = B85AA225,
         num_hs_graduate_GED = B85AC225,
         num_associates = B85AE225,
         num_bachelors = B85AF225,
         num_graduate_professional = B85AG225,
         num_not_in_labor_force = B84AF225,
         median_hh_income = B79AA225
         )%>%
  mutate(percent_female = num_female / total_pop,
         perc_age_0_17 = (age_under_5 + 
                            age_5_9 + 
                            age_10_14 + 
                            age_15_17) / total_pop,
         perc_age_18_34 = (age_18_19 + 
                             age_20 + 
                             age_21 + 
                             age_22_24 + 
                             age_25_29 + 
                             age_30_34) / total_pop,
         perc_age_35_59 = (age_35_44 +
                             age_45_54 +
                             age_55_59) / total_pop,
         perc_age_60_74 = (age_60_61 +
                             age_62_64 +
                             age_65_74) / total_pop,
         perc_75_up = (age_75_84 +
                         age_85_up) / total_pop,
         perc_black = num_black / total_pop,
         perc_asian = num_asian / total_pop,
         perc_white = num_white / total_pop,
         perc_hispanic = num_hispanic / total_pop,
         perc_less_hs = num_less_hs / total_pop,
         perc_associates = num_associates / total_pop,
         perc_bachelors = num_bachelors / total_pop,
         perc_graduate_professional = num_graduate_professional / total_pop,
         perc_not_in_labor_force = num_not_in_labor_force / total_pop,
         state_abbr = state.abb[match(STATE, state.name)],
         COUNTY = tolower(gsub(" County| Borough| Census Area| Municipality| Parish| city", "", COUNTY)), #remove suffixes
         county_state = paste(COUNTY, state_abbr, sep = "_") #combine county/states
         ) %>%
  select(county_state, percent_female, perc_age_0_17, perc_age_18_34, 
         perc_age_35_59, perc_age_60_74, perc_75_up, perc_black,
         perc_asian, perc_white, perc_hispanic, perc_less_hs, perc_associates,
         perc_bachelors, perc_graduate_professional, perc_not_in_labor_force,
         median_hh_income)

```

```{r get_police_killings, eval = FALSE}
police_killings_df <- read_excel("data/MPVDatasetDownload.xlsx", 
                                sheet = "2013-2024 Police Killings")

city_police_killings <- police_killings_df %>%
  filter(!is.na(City)) %>%
  mutate(`Date of Incident (month/day/year)` = as.Date(`Date of Incident (month/day/year)`),
         year = year(`Date of Incident (month/day/year)`),
         City = tolower(gsub(" County| Borough| Census Area| Municipality| Parish| city", "", City)),
         city_state = paste(City, State, sep = "_")) %>%
  filter(year >= 2016 & year <= 2020) %>%
  group_by(city_state) %>%
  summarize(count = n(), .groups = 'drop') %>%
  mutate(has_police_killing = ifelse(count > 0, 1, 0))

county_police_killings <- police_killings_df %>%
  filter(!is.na(County)) %>%
  mutate(`Date of Incident (month/day/year)` = as.Date(`Date of Incident (month/day/year)`),
         year = year(`Date of Incident (month/day/year)`),
         County = tolower(gsub(" County| Borough| Census Area| Municipality| Parish| city", "", County)),
         county_state = paste(City, State, sep = "_")) %>%
  filter(year >= 2016 & year <= 2020) %>%
  group_by(county_state) %>%
  summarize(count = n(), .groups = 'drop') %>%
  mutate(has_police_killing = ifelse(count > 0, 1, 0))
```

```{r get_funding_data}
load(file='data/38651-0001-Data.rda')

da38651.0001_filtered <- da38651.0001 %>%
  filter(AGENCYSAMPTYPE != "(5) State police") %>%
  dplyr::select(AGENCYNAME, AGENCYSAMPTYPE, CITY, STATE, OPBUDGET_2019, OPBUDGET) %>%
  mutate(
    CITY = str_trim(CITY, side = "both"),
    AGENCYNAME = str_trim(AGENCYNAME, side = "both"),
    AGENCYNAME = tolower(AGENCYNAME),
    City = tolower(CITY),
    County = ifelse(AGENCYSAMPTYPE == "(4) County police", 
                    str_extract(AGENCYNAME, ".*(?= county)"), NA),
    County = case_when(
       AGENCYNAME == "fraser winter park police department" ~ "grand",
       AGENCYNAME == "colonial regional police department" ~ "northampton",
       AGENCYNAME == "charleroi regional police department" ~ "washington",
       AGENCYNAME == "clear lake-ventura police department" ~ "calhoun",
       AGENCYNAME == "athens clarke county police department" ~ "clarke",
       AGENCYNAME == "saint charles county police department" ~ "st. charles",
       AGENCYNAME == "saint louis county police department" ~ "st. louis",
       AGENCYNAME == "bath police department" ~ "sagadahoc",
      AGENCYNAME == "somers town police department" ~ "westchester",
      AGENCYNAME == "little river - academy police department" ~ "bell",
      AGENCYNAME == "linn town police department" ~ "walworth",
      AGENCYNAME == "hot springs police department" ~ "garland",
      AGENCYNAME == "ventura police department buenaventura" ~ "ventura",
      AGENCYNAME == "west sacramento police department" ~ "yolo",
      AGENCYNAME == "miramar police department" ~ "broward",
      AGENCYNAME == "honolulu police department" ~ "honolulu",
      AGENCYNAME == "mcleansboro police department" ~ "hamilton",
      AGENCYNAME == "round lake park police department" ~ "lake",
      AGENCYNAME == "lasalle police department" ~ "cook",
      AGENCYNAME == "mount pulaski police department" ~ "logan",
      AGENCYNAME == "laporte police department" ~ "laporte",
      AGENCYNAME == "indianapolis metro police department" ~ "marion",
      AGENCYNAME == "lexington division of police" ~ "fayette",
      AGENCYNAME == "louisville metro police department" ~ "jefferson",
      AGENCYNAME == "barnstable police department" ~ "barnstable",
      AGENCYNAME == "dighton police department" ~ "bristol",
      AGENCYNAME == "seekonk police department" ~ "bristol",
      AGENCYNAME == "west tisbury police department" ~ "dukes",
      AGENCYNAME == "groveland police department" ~ "essex",
      AGENCYNAME == "methuen police department" ~ "essex",
      AGENCYNAME == "ashfield police department" ~ "franklin",
      AGENCYNAME == "west springfield police department" ~ "hampden",
      AGENCYNAME == "southampton police department" ~ "hampshire",
      AGENCYNAME == "littleton police department" ~ "middlesex",
      AGENCYNAME == "tyngsboro police department" ~ "middlesex",
      AGENCYNAME == "foxboro police department" ~ "norfolk",
      AGENCYNAME == "carver police department" ~ "plymouth",
      AGENCYNAME == "blackstone police department" ~ "worcester",
      AGENCYNAME == "hardwick police department" ~ "worcester",
      AGENCYNAME == "holden police department" ~ "worcester",
      AGENCYNAME == "southbridge police department" ~ "worcester",
      AGENCYNAME == "westminster police department" ~ "worcester",
      AGENCYNAME == "st michaels police" ~ "talbot",
      AGENCYNAME == "baileyville police department" ~ "washington",
      AGENCYNAME == "buxton police department" ~ "york",
      AGENCYNAME == "huron township police department" ~ "wayne",
      AGENCYNAME == "brownstown township police department" ~ "wayne",
      AGENCYNAME == "lees summit police department" ~ "jackson",
      AGENCYNAME == "city of o'fallon mo police department" ~ "st. charles",
      AGENCYNAME == "ste genevieve police department" ~ "ste. genevieve",
      AGENCYNAME == "winston-salem police department" ~ "forsyth",
      AGENCYNAME == "whispering pines police department" ~ "moore",
      AGENCYNAME == "center harbor police department" ~ "belknap",
      AGENCYNAME == "tuftonboro police department" ~ "carroll",
      AGENCYNAME == "harrisville police department" ~ "cheshire",
      AGENCYNAME == "carroll police department" ~ "coos",
      AGENCYNAME == "pelham police department" ~ "hillsborough",
      AGENCYNAME == "bow police department" ~ "merrimack",
      AGENCYNAME == "auburn police department" ~ "rockingham",
      AGENCYNAME == "east kingston police department" ~ "rockingham",
      AGENCYNAME == "nottingham police department" ~ "rockingham",
      AGENCYNAME == "lee police department" ~ "strafford",
      AGENCYNAME == "edgewater police" ~ "bergen",
      AGENCYNAME == "ho-ho-kus police" ~ "bergen",
      AGENCYNAME == "montvale police" ~ "bergen",
      AGENCYNAME == "norwood police" ~ "bergen",
      AGENCYNAME == "river vale police" ~ "bergen",
      AGENCYNAME == "wallington police department" ~ "bergen",
      AGENCYNAME == "woodcliff lake police" ~ "bergen",
      AGENCYNAME == "riverside township police" ~ "burlington",
      AGENCYNAME == "cherry hill police" ~ "camden",
      AGENCYNAME == "haddon heights police" ~ "camden",
      AGENCYNAME == "mount ephraim police" ~ "camden",
      AGENCYNAME == "pine valley police" ~ "camden",
      AGENCYNAME == "runnemede police" ~ "camden",
      AGENCYNAME == "avalon police department" ~ "cape may",
      AGENCYNAME == "belleville police" ~ "essex",
      AGENCYNAME == "bloomfield police" ~ "essex",
      AGENCYNAME == "cedar grove township police" ~ "essex",
      AGENCYNAME == "irvington police" ~ "essex",
      AGENCYNAME == "montclair police" ~ "essex",
      AGENCYNAME == "orange police" ~ "essex",
      AGENCYNAME == "verona police" ~ "essex",
      AGENCYNAME == "north bergen police" ~ "hudson",
      AGENCYNAME == "weehawken police" ~ "hudson",
      AGENCYNAME == "tewksbury township police" ~ "hunterdon",
      AGENCYNAME == "hamilton township police department" ~ "mercer",
      AGENCYNAME == "edison police" ~ "middlesex",
      AGENCYNAME == "atlantic highlands police" ~ "monmouth",
      AGENCYNAME == "neptune city police" ~ "monmouth",
      AGENCYNAME == "hazlet township police department" ~ "monmouth",
      AGENCYNAME == "riverdale police" ~ "morris",
      AGENCYNAME == "beachwood police" ~ "ocean",
      AGENCYNAME == "jackson township police" ~ "ocean",
      AGENCYNAME == "lavallette police" ~ "ocean",
      AGENCYNAME == "little egg harbor township police" ~ "ocean",
      AGENCYNAME == "point pleasant borough police" ~ "ocean",
      AGENCYNAME == "seaside heights police" ~ "ocean",
      AGENCYNAME == "prospect park police" ~ "passaic",
      AGENCYNAME == "wayne township police" ~ "passaic",
      AGENCYNAME == "west milford township police" ~ "passaic",
      AGENCYNAME == "far hills police" ~ "somerset",
      AGENCYNAME == "ogdensburg police" ~ "sussex",
      AGENCYNAME == "stanhope police" ~ "sussex",
      AGENCYNAME == "vernon township police" ~ "sussex",
      AGENCYNAME == "clark police department" ~ "union",
      AGENCYNAME == "winfield police" ~ "union",
      AGENCYNAME == "washington township police" ~ "warren",
      AGENCYNAME == "amherst town police department" ~ "erie",
      AGENCYNAME == "town of windham police department" ~ "greene",
      AGENCYNAME == "kent town police department" ~ "putnam",
      AGENCYNAME == "pound ridge town police department" ~ "westchester",
      AGENCYNAME == "west chester police department" ~ "hamilton",
      AGENCYNAME == "orange village police department" ~ "cuyahoga",
      AGENCYNAME == "fowler township police department" ~ "trumbull",
      AGENCYNAME == "hamilton township police department" ~ "warren",
      AGENCYNAME == "cumberland township police department" ~ "adams",
      AGENCYNAME == "mckees rocks borough police department" ~ "allegheny",
      AGENCYNAME == "south park township police department" ~ "allegheny",
      AGENCYNAME == "parks township police department" ~ "armstrong",
      AGENCYNAME == "rochester township police department" ~ "beaver",
      AGENCYNAME == "douglass township police department" ~ "berks",
      AGENCYNAME == "warminster township police department" ~ "bucks",
      AGENCYNAME == "buckingham township police department" ~ "bucks",
      AGENCYNAME == "east conemaugh borough police department" ~ "cambria",
      AGENCYNAME == "patton township police department" ~ "centre",
      AGENCYNAME == "upper uwchlan township police department" ~ "chester",
      AGENCYNAME == "west vincent township police department" ~ "chester",
      AGENCYNAME == "upper allen township police department" ~ "cumberland",
      AGENCYNAME == "darby township police department" ~ "delaware",
      AGENCYNAME == "upper darby township police department" ~ "delaware",
      AGENCYNAME == "upper providence township police department" ~ "delaware",
      AGENCYNAME == "scott township police department" ~ "lackawanna",
      AGENCYNAME == "ephrata police department" ~ "lancaster",
      AGENCYNAME == "union township police department" ~ "lawrence",
      AGENCYNAME == "courtdale borough police department" ~ "luzerne",
      AGENCYNAME == "grove city police department" ~ "mercer",
      AGENCYNAME == "granville township police department" ~ "mifflin",
      AGENCYNAME == "east norriton township police department" ~ "montgomery",
      AGENCYNAME == "lower pottsgrove township police department" ~ "montgomery",
      AGENCYNAME == "lower frederick township police department" ~ "montgomery",
      AGENCYNAME == "limerick township police department" ~ "montgomery",
      AGENCYNAME == "upper nazareth township police department" ~ "northampton",
      AGENCYNAME == "rush township police department" ~ "schuylkill",
      AGENCYNAME == "cecil township police department" ~ "washington",
      AGENCYNAME == "allegheny township police department" ~ "westmoreland",
      AGENCYNAME == "lower windsor township police department" ~ "york",
      AGENCYNAME == "west warwick police" ~ "kent",
      AGENCYNAME == "north smithfield police" ~ "providence",
      AGENCYNAME == "north kingstown police" ~ "washington",
      AGENCYNAME == "south kingstown police" ~ "washington",
      AGENCYNAME == "new shoreham police" ~ "washington",
      AGENCYNAME == "mccormick police department" ~ "mccormick",
      AGENCYNAME == "metro nashville police department" ~ "davidson",
      AGENCYNAME == "rutland town police department" ~ "rutland",
    TRUE ~ County),
    STATE = case_when(
      AGENCYNAME == "bath police department" ~ "ME",
      AGENCYNAME == "metropolitan police department - dc" ~ "NA",
      TRUE ~ STATE),
    City = str_replace(City, " city$", ""),
    City = if_else(str_detect(AGENCYNAME, "borough") & 
                     !str_detect(City, "pittsburgh") &
                     !str_detect(City, "king salmon") &
                     !str_detect(City, "marlborough") &
                     !str_detect(City, "gloucester") &
                     !str_detect(City, "point pleasant boro") &
                     !str_detect(City, "mc kees rocks") &
                     !str_detect(City, "conemaugh") &
                     !str_detect(City, "johnstown") &
                     !str_detect(City, "erie") &
                     !str_detect(City, "wilkes barre") &
                     !str_detect(City, "jonesborough"), 
                   paste(City, "borough"), 
                   City),
    City = if_else(str_detect(City, "saint"),str_replace(City, "saint", "st."), City),
    City = if_else(str_detect(City, "\\bn\\b"), str_replace(City, "\\bn\\b", "north"), City),
    City = if_else(str_detect(City, "\\bs\\b"), str_replace(City, "\\bs\\b", "south"), City),
    City = case_when(
      AGENCYNAME == "milford police department" ~ "milford (balance)",
      AGENCYNAME == "old saybrook center" ~ "old saybrook center",
      AGENCYNAME == "westport police department" ~ "long hill (fairfield)",
      AGENCYNAME == "stratford police department" ~ "stratford downtown",
      AGENCYNAME == "bedford police department" ~ "coaldale borough (bedford)",
      TRUE ~ City
    ),
    is_city = ifelse(!is.na(County), 0, 1),
    county_state = ifelse(!is.na(County), paste(County, STATE, sep= "_"), NA),
    city_state = ifelse(AGENCYSAMPTYPE == "(3) Local police", paste(City, STATE, sep= "_"), NA)
    ) %>%
    filter(!is.na(OPBUDGET_2019) & !is.na(OPBUDGET)) # REMOVE EVENTUALLY

```

```{r combine_dfs}
counties <- da38651.0001_filtered %>%
  filter(!is.na(County)) %>%
  left_join(counties_blm) %>%
  left_join(counties_demo) %>%
  left_join(counties_pol_ideo) %>%
  left_join(county_police_killings) %>%
  mutate(violent_protest = ifelse(is.na(violent_protest), 0, violent_protest),
         peaceful_protest = ifelse(is.na(peaceful_protest), 0, peaceful_protest),
         has_police_killing = ifelse(is.na(has_police_killing), 0, police_killings))
  
cities <- da38651.0001_filtered %>%
  filter(AGENCYSAMPTYPE == "(3) Local police") %>%
  left_join(counties_blm) %>%
  left_join(cities_demo) %>%
  left_join(cities_pol_ideo) %>%
  left_join(city_police_killings) %>%
  mutate(violent_protest = ifelse(is.na(violent_protest), 0, violent_protest),
         peaceful_protest = ifelse(is.na(peaceful_protest), 0, peaceful_protest),
         has_police_killing = ifelse(is.na(has_police_killing), 0, has_police_killing))

View(filter(cities, is.na(percent_female)))

  
```


```{r combine_dfs, eval = FALSE}
# Combine financial data
df <- left_join(combined_df, doj_grant_df_processed, by = c("year", "county_state")) %>%
  mutate(prop_police = ifelse(is.na(prop_police), 0, prop_police))

# Combine protest data
df <- left_join(df, blm_df_processed, by = c("year", "county_state")) %>%
  mutate(violent_protest = ifelse(is.na(violent_protest), 0, violent_protest),
         peaceful_protest  = ifelse(is.na(peaceful_protest), 0, peaceful_protest))

#Combine political data
df <- left_join(df, pol_ideo_df)

# Combine demographic data
df <- left_join(df, demo_df)

df <- left_join(df, police_killings_perc)

protest_data <- df %>%
  mutate(mean_per_capita_killings =  ifelse(is.na(mean_per_capita_killings), 
                                            0, mean_per_capita_killings),
        violent_protest = ifelse(year != 2020, NA, violent_protest),
        peaceful_protest = ifelse(year != 2020, NA, peaceful_protest),
        mrp_ideology = ifelse(year != 2020, NA, mrp_ideology),
        percent_female = ifelse(year != 2020, NA, percent_female),
        perc_age_0_17 = ifelse(year != 2020, NA, perc_age_0_17),
        perc_age_18_34 = ifelse(year != 2020, NA, perc_age_18_34),
        perc_age_35_59 = ifelse(year != 2020, NA, perc_age_35_59),
        perc_age_60_74 = ifelse(year != 2020, NA, perc_age_60_74),
        perc_75_up = ifelse(year != 2020, NA, perc_75_up),
        perc_black = ifelse(year != 2020, NA, perc_black),
        perc_asian = ifelse(year != 2020, NA, perc_asian),
        perc_white = ifelse(year != 2020, NA, perc_white),
        perc_hispanic = ifelse(year != 2020, NA, perc_hispanic),
        perc_less_hs = ifelse(year != 2020, NA, perc_less_hs),
        perc_associates = ifelse(year != 2020, NA, perc_associates),
        perc_bachelors = ifelse(year != 2020, NA, perc_bachelors),
        perc_graduate_professional = ifelse(year != 2020, NA, perc_graduate_professional),
        perc_not_in_labor_force = ifelse(year != 2020, NA, perc_not_in_labor_force),
        median_hh_income = ifelse(year != 2020, NA, median_hh_income),
        mean_per_capita_killings = ifelse(year != 2020, NA, mean_per_capita_killings)
  )

protest_data_filtered <- protest_data %>%
  filter(year == 2020) %>%
  select(!county_state)

protest_data_filtered <- as.data.frame(protest_data_filtered)

protest_imputed <- missForest(protest_data_filtered)

protest_data_final <- cbind(protest_data %>%
                              filter(year == 2020) %>%
                              select(county_state),
                            protest_imputed$ximp)

non_2020_data <- protest_data %>%
  filter(year != 2020)

# Combine the non-2020 data with the imputed 2020 data
full_protest_data <- bind_rows(non_2020_data, protest_data_final)
  
save(full_protest_data, file = "full_protest_data.RData")

```

## Descriptive Statistics

<br />

```{r show_min_max}
load("full_protest_data.RData")

# Filter the data
#filtered_data <- full_protest_data %>%
  #filter(year == 2020)

#min_max <- sapply(filtered_data, function(x) c(min = min(x, na.rm = TRUE), max = max(x, na.rm = TRUE)))

# Convert the result to a data frame for better readability
#min_max_df <- as.data.frame(t(min_max))

#rows_to_exclude <- c("county_state", "year", "violent_protest", "peaceful_protest")

#min_max_df <- min_max_df[!rownames(min_max_df) %in% rows_to_exclude, ]

# Display the summary table
#kable(min_max_df, format = "markdown", caption = "Min and Max Values of Each Variable")
  
```

```{r fix_skewness}
transform_skewed_data <- function(data) {
  before_skewness <- c()  # Vector to store skewness values before transformation
  
  for (col in colnames(data)) {
    before_skewness <- c(before_skewness, moments::skewness(data[[col]]))  # Record skewness before transformation
    
    skewness_value <- moments::skewness(data[[col]])
    
    if (skewness_value > 1) {
      # Log transform for high positive skewness
      data[[col]] <- log(data[[col]] + 1)  # Adding 1 to avoid log(0)
    } else if (skewness_value < -1) {
      # Square root transform for high negative skewness
      data[[col]] <- sqrt(max(data[[col]] + 1) - data[[col]])
    } else if (skewness_value > 0.5) {
      # Square root transform for moderate positive skewness
      data[[col]] <- sqrt(data[[col]])
    } else if (skewness_value < -0.7) {
      # Square transform for moderate negative skewness
      data[[col]] <- (max(data[[col]]) - data[[col]])^2
    }
    
    # Standardize the data
    #data[[col]] <- scale(data[[col]])
  }
  
  after_skewness <- sapply(data, moments::skewness)  # Calculate skewness after transformation
  
  # Create a data frame to display skewness values before and after transformation
  skewness_table <- data.frame(
    Variable = colnames(data),
    Before_Transformation = before_skewness,
    After_Transformation = after_skewness
  )
  
  return(data)
}

# Assuming your data frame is named full_protest_data
test <- full_protest_data %>%
  filter(year == 2020) %>%
  select(mrp_ideology, percent_female, perc_age_0_17, 
         perc_age_18_34, perc_age_35_59, perc_age_60_74, perc_75_up,
         perc_black, perc_white, perc_hispanic, perc_less_hs,
         perc_associates, perc_bachelors, perc_graduate_professional,
         perc_not_in_labor_force, median_hh_income)

# Transform and standardize skewed data
normalized_test <- transform_skewed_data(test)

# Function to create histogram using ggplot
create_histogram <- function(data, var_name) { #add print to show skewness plots
  hist <- ggplot(data, aes_string(x = var_name)) +
    geom_histogram(binwidth = 0.5, fill = "blue", color = "black", alpha = 0.7) +
    labs(title = paste("Histogram of", var_name), x = var_name, y = "Frequency") +
    theme_minimal()
}

# Function to create Q-Q plot using ggplot
create_qqplot <- function(data, var_name) { #add print to show skewness plots
  qqplot<- ggplot(data, aes_string(sample = var_name)) +
    stat_qq() +
    stat_qq_line(col = "red") +
    labs(title = paste("Q-Q Plot of", var_name), x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme_minimal()
}

for (var_name in colnames(normalized_test)) {
  create_histogram(normalized_test, var_name)
  create_qqplot(normalized_test, var_name)
}

protest_data_filtered <- full_protest_data %>%
  filter(year == 2020)

year_2020 <- rep(2020, nrow(normalized_test))

# Merge county_state column from full_protest_data with normalized_test
normalized_test_with_county_state <- cbind(year = year_2020, 
                                           county_state = protest_data_filtered$county_state,
                                           prop_police = protest_data_filtered$prop_police,
                                           violent_protest = protest_data_filtered$violent_protest,
                                           peaceful_protest = protest_data_filtered$peaceful_protest,
                                           normalized_test)

full_protest_data <- full_protest_data %>%
  select(-perc_asian, -mean_per_capita_killings) %>%
  filter(year != 2020) %>%
  rbind(normalized_test_with_county_state)
  
```

#### Trends in Funding

Overall, the proportion of federal funding allocated to counties steadily decreased until reaching an all-time low in 2020. However, after 2020, this trend reversed, and the funding increased and went back to levels pre-2020.

When excluding counties that don't receive any federal funding for policing each year, the dynamics change significantly. In counties that do receive federal support for policing, the majority of the funding is often directed towards policing, and the trend appears much more erratic.

```{r show_total_fed_funding}
# Plot the aggregated data
sum_by_date_filtered <- full_protest_data[full_protest_data$year != 2009, ]

average_by_year_total <- sum_by_date_filtered %>%
  group_by(year) %>%
  summarize(average_obligated_amount = mean(prop_police, na.rm = TRUE) * 100) %>%
  ungroup()

# Plot the average obligated amount by year
plot1 <- ggplot(average_by_year_total, aes(x = year, y = average_obligated_amount)) +
  geom_point() +
  labs(x = "Year", y = "Average Obligated Amount", 
       title = "Total Federal Funding for County Policing") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0, 80, by = 10), limits = c(0, 80))

```

```{r show_filtered_fed_funding, fig.height = 8, fig.width = 18}
# Plot the aggregated data
sum_by_date_filtered <- doj_grant_df_processed[doj_grant_df_processed$year != 2009, ]

average_by_year <- sum_by_date_filtered %>%
  group_by(year) %>%
  summarize(average_obligated_amount = mean(prop_police, na.rm = TRUE)* 100) %>%
  ungroup()

# Plot the average obligated amount by year
plot2 <- ggplot(average_by_year, aes(x = year, y = average_obligated_amount)) +
  geom_point() +
  labs(x = "Year", y = "Average Obligated Amount", 
       title = "Federal Funding for County Policing (Excludes Counties where police funding == 0 in a year") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0, 80, by = 10), limits = c(0, 80))

grid.arrange(plot1, plot2, nrow = 1)

```

## Propensity Scores

I tested producing propensity scores using 3 sets of data

  - Historical Funding data
  - County Demographics
  - Historical Funding Data and County Demographics

<br/ >

### Historical
```{r process_peaceful_hist}
treatment_peaceful <- full_protest_data %>%
  select(county_state, peaceful_protest) %>%
  filter(!is.na(peaceful_protest))

peaceful_protests_prop_scores <- full_protest_data %>%
  group_by(county_state, year) %>%
  summarise(prop_police = mean(prop_police, na.rm = TRUE)) %>%
  pivot_wider(names_from = year, values_from = prop_police) %>%
  select(-`2020`, -`2021`, -`2022`, -`2023`) %>%
  left_join(treatment_peaceful)
```

```{r show_peaceful_hist_p_score, echo = TRUE}
p_score <- glm(peaceful_protest ~ `2010` + `2011` + `2012` + `2013` + `2014` + 
                 `2015` + `2016` + `2017` + `2018` + `2019`,
               data = peaceful_protests_prop_scores,
               family = binomial(link = "logit"))
```

```{r predict_peaceful_hist}
peaceful_protests_prop_scores$p_score <- predict(p_score, type = "response")

peaceful_p_scores <- ggplot(peaceful_protests_prop_scores) + 
  aes(x = p_score, fill = factor(peaceful_protest), color = factor(peaceful_protest)) + 
  geom_density(alpha = 0.5) +
  xlab("P-Score") +
  ylab("Density") +
  labs(fill = "peaceful_protest", color = "peaceful_protest", 
       title = "Propensity Scores: Peaceful Protest: Historical Funding") + theme_minimal()

```


```{r process_violent_hist, fig.height = 7, fig.width = 15}
treatment_violent <- full_protest_data %>%
  select(county_state, violent_protest) %>%
  filter(!is.na(violent_protest))

violent_protests_prop_scores <- full_protest_data %>%
  group_by(county_state, year) %>%
  summarise(prop_police = mean(prop_police, na.rm = TRUE)) %>%
  pivot_wider(names_from = year, values_from = prop_police) %>%
  select(-`2020`, -`2021`, -`2022`, -`2023`) %>%
  left_join(treatment_violent)

p_score <- glm(violent_protest ~ `2010` + `2011` + `2012` + `2013` + `2014` + 
                 `2015` + `2016` + `2017` + `2018` + `2019`,
               data = violent_protests_prop_scores,
               family = binomial(link = "logit"))

violent_protests_prop_scores$p_score <- predict(p_score, type = "response")

violent_p_scores <- ggplot(violent_protests_prop_scores) + 
  aes(x = p_score, fill = factor(violent_protest), color = factor(violent_protest)) + 
  geom_density(alpha = 0.5) +
  xlab("P-Score") +
  ylab("Density") +
  labs(fill = "violent_protest", color = "violent_protest",
       title = "Propensity Scores: Violent Protest: Historical Funding") + 
  theme_minimal()

grid.arrange(peaceful_p_scores, violent_p_scores, nrow = 1)

```

### County Demographics

```{r process_peaceful_demo, fig.height = 7, fig.width = 15}
protest_data_demo <- full_protest_data %>%
  filter(year == 2020) %>%
  select(county_state, mrp_ideology, percent_female, perc_age_0_17, 
         perc_age_18_34, perc_age_35_59, perc_age_60_74, perc_75_up,
         perc_black, perc_white, perc_hispanic, perc_less_hs,
         perc_associates, perc_bachelors, perc_graduate_professional,
         perc_not_in_labor_force, median_hh_income)

peaceful_protests_prop_scores_demo <- protest_data_demo %>%
  left_join(treatment_peaceful)

```

```{r show_peaceful_demo_p_score, echo = TRUE}
p_scores_demo_peaceful <- glm(peaceful_protest ~ mrp_ideology + percent_female +
                                perc_age_0_17 + perc_age_18_34 + perc_age_35_59 + 
                                perc_age_60_74 + perc_75_up + perc_black + 
                                perc_white + perc_hispanic +
                                perc_less_hs + perc_associates + perc_bachelors + 
                                perc_graduate_professional + perc_not_in_labor_force + 
                                median_hh_income,
                              data = peaceful_protests_prop_scores_demo,
                              family = binomial(link = "logit"))
```

```{r predict_peaceful_demo}
peaceful_protests_prop_scores_demo$p_score <- predict(p_scores_demo_peaceful, 
                                                      newdata = peaceful_protests_prop_scores_demo,
                                                      type = "response")

plot_demo_peaceful <- ggplot(peaceful_protests_prop_scores_demo) + 
  aes(x = p_score, fill = factor(peaceful_protest), color = factor(peaceful_protest)) + 
  geom_density(alpha = 0.5) +
  xlab("P-Score") +
  ylab("Density") +
  labs(fill = "peaceful_protest", color = "peaceful_protest",
       title = "Propensity Scores: Peaceful Protest: County Demographics") + 
  theme_minimal()
```

```{r process_violent_demo, fig.height = 7, fig.width = 15}
violent_protests_prop_scores_demo <- full_protest_data %>%
  group_by(county_state, year) %>%
  summarise(prop_police = mean(prop_police, na.rm = TRUE)) %>%
  pivot_wider(names_from = year, values_from = prop_police) %>%
  select(-`2020`, -`2021`, -`2022`, -`2023`) %>%
  left_join(treatment_violent) %>%
  left_join(protest_data_demo)

p_scores_demo_violent <- glm(violent_protest ~ `2010` + `2011` + `2012` + `2013` + `2014` + 
                 `2015` + `2016` + `2017` + `2018` + `2019` + mrp_ideology + percent_female + 
                   perc_age_0_17 + perc_age_18_34 + perc_age_35_59 + 
                   perc_age_60_74 + perc_75_up + perc_black + 
                   perc_white + perc_hispanic +
                   perc_less_hs + perc_associates + perc_bachelors + 
                   perc_graduate_professional + perc_not_in_labor_force + 
                   median_hh_income,
               data = violent_protests_prop_scores_demo,
               family = binomial(link = "logit"))

violent_protests_prop_scores_demo$p_score <- predict(p_scores_demo_violent, 
                                                     newdata = violent_protests_prop_scores_demo,
                                                     type = "response")

plot_demo_violent <- ggplot(violent_protests_prop_scores_demo) + 
  aes(x = p_score, fill = factor(violent_protest), color = factor(violent_protest)) + 
  geom_density(alpha = 0.5) +
  xlab("P-Score") +
  ylab("Density") +
  labs(fill = "violent_protest", color = "violent_protest",
       title = "Propensity Scores: Violent Protest: County Demographics") + 
  theme_minimal()

grid.arrange(plot_demo_peaceful, plot_demo_violent, nrow = 1)
```

### Historical + County Demographics

```{r process_peaceful_hist_demo}
peaceful_protests_prop_scores_demo_hist <- full_protest_data %>%
  group_by(county_state, year) %>%
  summarise(prop_police = mean(prop_police, na.rm = TRUE)) %>%
  pivot_wider(names_from = year, values_from = prop_police) %>%
  select(-`2020`, -`2021`, -`2022`, -`2023`) %>%
  left_join(treatment_peaceful) %>%
  left_join(protest_data_demo)

```

```{r show_peaceful_hist_demo, echo = TRUE}
p_scores_demo_hist_peaceful <- glm(peaceful_protest ~ `2010` + `2011` + `2012` + 
                                `2013` + `2014` + `2015` + `2016` + `2017` + 
                                `2018` + `2019` + mrp_ideology + percent_female +
                                perc_age_0_17 + perc_age_18_34 + perc_age_35_59 + 
                                perc_age_60_74 + perc_75_up + perc_black + 
                                perc_white + perc_hispanic +
                                perc_less_hs + perc_associates + perc_bachelors + 
                                perc_graduate_professional + perc_not_in_labor_force + 
                                median_hh_income,
                              data = peaceful_protests_prop_scores_demo_hist,
                              family = binomial(link = "logit"))

```

```{r predict_peaceful_hist_demo}
peaceful_protests_prop_scores_demo_hist$p_score <- predict(p_scores_demo_hist_peaceful, 
                                                      newdata = peaceful_protests_prop_scores_demo_hist,
                                                      type = "response")

plot_demo_hist_peaceful <- ggplot(peaceful_protests_prop_scores_demo_hist) + 
  aes(x = p_score, fill = factor(peaceful_protest), color = factor(peaceful_protest)) + 
  geom_density(alpha = 0.5) +
  xlab("P-Score") +
  ylab("Density") +
  labs(fill = "peaceful_protest", color = "peaceful_protest",
       title = "Propensity Scores: Peaceful Protest: County Demographics + Historical") + 
  theme_minimal()
```

```{r process_violent_hist_demo, fig.height = 7, fig.width = 15}
violent_protests_prop_scores_demo_hist <- full_protest_data %>%
  group_by(county_state, year) %>%
  summarise(prop_police = mean(prop_police, na.rm = TRUE)) %>%
  pivot_wider(names_from = year, values_from = prop_police) %>%
  select(-`2020`, -`2021`, -`2022`, -`2023`) %>%
  left_join(treatment_violent) %>%
  left_join(protest_data_demo)

p_scores_demo_hist_violent <- glm(violent_protest ~ `2010` + `2011` + `2012` + `2013` + `2014` + 
                 `2015` + `2016` + `2017` + `2018` + `2019` + mrp_ideology + percent_female + 
                   perc_age_0_17 + perc_age_18_34 + perc_age_35_59 + 
                   perc_age_60_74 + perc_75_up + perc_black +
                   perc_white + perc_hispanic +
                   perc_less_hs + perc_associates + perc_bachelors + 
                   perc_graduate_professional + perc_not_in_labor_force + 
                   median_hh_income,
               data = violent_protests_prop_scores_demo_hist,
               family = binomial(link = "logit"))

violent_protests_prop_scores_demo_hist$p_score <- predict(p_scores_demo_hist_violent, 
                                                     newdata = violent_protests_prop_scores_demo_hist,
                                                     type = "response")

plot_demo_hist_violent <- ggplot(violent_protests_prop_scores_demo_hist) + 
  aes(x = p_score, fill = factor(violent_protest), color = factor(violent_protest)) + 
  geom_density(alpha = 0.5) +
  xlab("P-Score") +
  ylab("Density") +
  labs(fill = "violent_protest", color = "violent_protest",
       title = "Propensity Scores: Violent Protest: County Demographics + Historical") + 
  theme_minimal()

grid.arrange(plot_demo_hist_peaceful, plot_demo_hist_violent, nrow = 1)
```

#### Question 1a: Should I use the propensity scores with just county data because it shows a better difference in propensity scores for the treatment and control groups? (This is not obvious for violent protests but it seems obvious for peaceful protests)

#### Question 1b: Given these density graphs, can I use the propensity scores with historical + county demographics for my sensitivity analysis?

<br/ >

## Matching

#### Question 2: I removed Percent Asian and police killings per capita because the data was highly skewed and I couldn't get balance in the treatment and control groups. What do you think of this?

#### Question 3: One to one matching, replacement and the genetic method seems to get me closest to the difference in the groups being not significant but when I calculate the p-values, I get a lot of them less than 0.05. What is going on here? (I am using `t.test` to calculate the p-value)

```{r, echo = TRUE}
m_out <- MatchIt::matchit(peaceful_protest~p_score, 
                          data = peaceful_protests_prop_scores_demo,
                          method = "genetic",
                          ratio = 1,
                          replace = T,
                          distance = "mahalanobis")

```

```{r}
m_data <- MatchIt::match.data(m_out)

counts <- table(m_data$peaceful_protest)
num_control <- counts[as.character(0)]  # Number of control units
num_treatment <- counts[as.character(1)]

data_2020 <- full_protest_data %>%
  filter(year == 2020)

cat("The matched data set has", dim(m_data)[1], "counties.", num_control, "are in control",
    num_treatment, "are in treatment.", "The original dataset had", nrow(data_2020), "counties.")

```


```{r}
# Initialize an empty data frame to store results
result_table <- data.frame(
  Variable = character(),
  Control_Mean = numeric(),
  Treatment_Mean = numeric(),
  P_Value = numeric(),
  stringsAsFactors = FALSE
)

# List of variables to analyze
variables <- c("mrp_ideology", "percent_female", "perc_age_0_17", "perc_age_18_34",
                "perc_age_35_59", "perc_age_60_74", "perc_75_up", "perc_black",
                "perc_white", "perc_hispanic", "perc_less_hs",
                "perc_associates", "perc_bachelors", "perc_graduate_professional",
                "perc_not_in_labor_force", "median_hh_income")

# Loop over each variable
for (variable in variables) {
  # Perform t-test and compute means for treatment and control groups
  test <- t.test(m_data[[variable]][m_data$peaceful_protest == 1], 
                 m_data[[variable]][m_data$peaceful_protest == 0])
  mean_treatment <- mean(m_data[[variable]][m_data$peaceful_protest == 1], na.rm = TRUE)
  mean_control <- mean(m_data[[variable]][m_data$peaceful_protest == 0], na.rm = TRUE)
  
  # Create a new row for the result_table
  new_row <- data.frame(
    Variable = variable,
    Control_Mean = as.numeric(mean_control),
    Treatment_Mean = as.numeric(mean_treatment),
    P_Value = as.numeric(test$p.value),
    stringsAsFactors = FALSE
  )
  
  # Append the new row to result_table
  result_table <- bind_rows(result_table, new_row)
}

# Print result_table
kable(result_table)

```

### First Attempt at Diff in Diff

```{r diff_in_diff_set_up}
outcome_vars <- full_protest_data %>%
  group_by(county_state, year) %>%
  summarise(prop_police = mean(prop_police, na.rm = TRUE)) %>%
  filter(year == 2019 | year == 2021) %>%
  mutate(year = ifelse(year == 2019, 0, 1)) %>%
  rename(time = year)

diff_in_diff_df <- m_data %>%
  select(county_state, peaceful_protest) %>%
  slice(rep(1:n(), each = 2)) %>%
  mutate(time =rep(0:1, length.out = n()) ) %>%
  left_join(outcome_vars, by = c("county_state", "time"))

```

```{r diff_in_diff, echo = TRUE}
diff_diff_output <- lm(prop_police ~ peaceful_protest*time, data = diff_in_diff_df)

summary(diff_diff_output)
```

#### First Attempt at Parallel Trends

```{r testing_parallel_trends, echo = TRUE}
parallel_trends_df <- full_protest_data %>%
  group_by(county_state, year) %>%
  summarise(prop_police = mean(prop_police, na.rm = TRUE)) %>%
  left_join(protest_data_demo) %>%
  left_join(treatment_peaceful)

# Define the regression model
reg1 <- lm(prop_police ~ peaceful_protest * factor(year), data = parallel_trends_df)

# Extract coefficients for interaction terms
coefs <- coef(reg1)[grep("peaceful_protest:factor\\(year\\)", names(coef(reg1)))]
upper <- confint(reg1, vcov. = vcovHC(reg1, type = "HC0"))[grep("peaceful_protest:factor\\(year\\)", rownames(confint(reg1))), 2]
lower <- confint(reg1, vcov. = vcovHC(reg1, type = "HC0"))[grep("peaceful_protest:factor\\(year\\)", rownames(confint(reg1))), 1]

# Create a data frame with coefficients and confidence intervals
estudy <- data.frame(
  year = as.numeric(gsub("peaceful_protest:factor\\(year\\)", "", names(coefs))),
  coefs = coefs,
  lower = lower,
  upper = upper
)

# Add a row for the baseline year
new_row <- data.frame(coefs = 0, lower = 0, upper = 0, year = 2010)
estudy <- rbind(estudy, new_row) %>% arrange(year)

# Plot the coefficients
ggplot(estudy, aes(x = year, y = coefs)) +
  geom_vline(xintercept = 2020, color = "pink", linetype = 'dashed', alpha = 0.75, size = 1) +
  geom_hline(yintercept = 0, color = "grey") +
  geom_point(color = "blue", size = 3, alpha = 0.75) +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = lower, ymax = upper), color = "blue", width = 0.2) +
  theme_minimal() +
  labs(x = "Year", y = "Coefficient", title = "Parallel Trends Test") +
  xlim(2010, NA)

```


```{r, eval = FALSE}
tmap_mode("view")

vis <- tm_shape(shp) + 
  tm_borders()

blm_filtered <- blm_df %>%
  filter(year == 2020 & sub_event_type != "Peaceful protest")

year_counts <- blm_filtered %>%
  group_by(sub_event_type) %>%
  summarize(count = n())

# Display the counts
print(year_counts) 

unique(raw_filtered_2020$admin2)

protests <- st_as_sf(raw_filtered_2020, coords = c("longitude", "latitude"))

vis <- vis + tm_shape(protests) +
  tm_bubbles(size=0.05, col = "event_type", alpha =0.5)
```

```{r, eval = FALSE}
vis <- tm_shape(shp) + 
  tm_borders()

raw_filtered_2021 <- raw %>%
  filter(year == 2021)

protests <- st_as_sf(raw_filtered_2021, coords = c("longitude", "latitude"))

vis <- vis + tm_shape(protests) +
  tm_bubbles(size=0.2, col = "event_type", alpha =0.5)
```

```{r, eval = FALSE}
vis <- tm_shape(shp) + 
  tm_borders()

raw_filtered_2022 <- raw %>%
  filter(year == 2022)

protests <- st_as_sf(raw_filtered_2022, coords = c("longitude", "latitude"))

vis <- vis + tm_shape(protests) +
  tm_bubbles(size=0.2, col = "event_type", alpha =0.5)
```

